---
title: "Stick Insect Climate PCA"
output: 
  html_notebook:
    theme: flatly
    highlight: tango
---

Read in the packages. The working directory is wherever the R Notebook is located. 

```{r include = FALSE}
packages <- c("raster", "data.table", "tidyverse", "sf", "RStoolbox", "leaflet", "plotly", "gdata", "BSDA", "ade4", "readxl", "janitor", "rnaturalearth", "adehabitatHS") #RStoolbox has some dependencies like openMP that can be difficult to compile on a Mac (needed for the dependent package "caret"). If you have High Sierra OS or newer, search for instructions specific to your OS- it's a lot easier than older OS's.
lapply(packages, require, character.only = TRUE)
source("R/plot_leaflet_function.R") #source locality plotting function
source("R/plot_climate_pca_function.R") #source pca plotting function
source("R/species_pca_function.R") #source function that computes climate pca per species
source("R/min_convex_poly.R") #source function that creates a minimum convex polygon around points
source("R/enfa_calc_function.R")
source("R/marginality_lollipop_plot.R")
source("R/presence_absence_raster_function.R")
source("R/crop_background_env_function.R")
```


Read in the spreadsheet and take a look at the data.

```{r}
###read in spreadsheet
loc <- read_xlsx("Original-spreadsheets/all species New_6-14-19.xlsx") %>% 
  janitor::clean_names() %>% 
  mutate(reproductive_mode = as.factor(reproductive_mode)) 

#get the number of individuals, and the sexuality counts per species
count_repro_mode <- loc %>% 
  group_by(genus, species, reproductive_mode) %>% 
  count() %>% 
  mutate(genus_species = str_c(genus, species, sep = "_"),
         genus_species = str_replace_all(genus_species, " ", "_"),
         genus_species = str_replace_all(genus_species, "\\.", "")) %>% 
  ungroup() %>% 
  mutate(genus_species = fct_reorder(genus_species, n, sum)) %>% 
  ggplot(aes(x = genus_species, y = n, fill = reproductive_mode)) +
  geom_col() +
  coord_flip() + 
  theme_minimal()

count_repro_mode
```

##Map
Plot a leaflet map of the localities. The leaflet map is interactive. You can click on the localities and a flag with some metadata will pop up! 

```{r}
#make locality shape file and assign WGS coord system
coord_points <- st_as_sf(loc, coords = c("longitude", "latitude"), 
                         crs = 4326, agr = "constant")

#use sourced plot_locs_leaflet script to plot localities
all_plot <- plot_locs_leaflet(loc, "reproductive_mode")

all_plot
#in case I want to save the map somewhere
#mapview::mapshot(all_plot, url = paste0(getwd(), "/plots/repro_mode_plots/all_species_map.html"), file = paste0(getwd(), "/plots/repro_mode_plots/all_species_map.pdf"))
```

##PCA-Genera {.tabset}

###Climate Data
Obtain the bioclim layers for analysis. I'm using all 19 for this preliminary exploration. I plotted the first bioclim just to make sure nothing seems wonky. I'm using CHELSA data downloaded from their website. Since the files are huge, I only unzip them one at a time, crop them, and write them to GeoTiff files that I can then load in as a rasterstack.
```{r}
##get chelsa data
#chelsa_folder <- "/Users/connorfrench/Dropbox/Old_Mac/climate-data/chelsa_30s_bio"
#zip_files <- list.files(chelsa_folder, full.names = TRUE)

#using the Unarchiver commandline tools for Mac to unzip the 7zip chelsa layers. Regular unzip() does not work with 7z zipped files
#for (file in zip_files) {
  #set temp directory
#  tempd <- tempdir()
#  system(paste("unar", file, "-o", tempd))
#  r <- raster(list.files(tempd, pattern = "*.tif", full.names = TRUE)) %>%
#    crop(extent(166, 179, -48, -34))
#  writeRaster(r, filename = paste0("~/Desktop/", list.files(tempd, pattern = "*.tif")), format = "GTiff")
#  unlink(tempd, recursive = TRUE)
#}

clim_files <- "/Users/connorfrench/Dropbox/Old_Mac/climate-data/chelsa_30sec_NewZealand/chelsa_bioclims_NZ.tif"
w <- stack(clim_files)


```


###PCA by locality
This is a PCA of the climate data extracted for each locality, rather than a PCA of the total climate space.

Run the pca and check out variable loadings and proportion of variance explained by components.

```{r}
#extract data from worldclim for each locality. Making this into a data frame with columns labeled so the row labeling lines up after I remove the NAs.
#extract data from worldclim for each locality.
coords <- data.frame(latitude = loc$longitude, longitude = loc$latitude)

loc.clim <- dplyr::bind_cols(loc, raster::extract(w, coords, method = "simple", df = TRUE)) %>% 
  drop_na(chelsa_bioclims_NZ.1) %>% 
  dplyr::select(-ID)

#make a matrix of only bioclim values
clim.mat <- loc.clim[,grep("bio", names(loc.clim))] %>% as.matrix()

#run pca on climate variables
clim.pca <- prcomp(clim.mat, scale = TRUE)
summary.pca <- summary(clim.pca) #check out the components

#plot tables
summary.pca
knitr::kable(round(clim.pca$rotation[,1:3],3)) #Table of loading scores for the first 3 PCs.
```

Two plots: One plot of the PCA colored according to genus, with convex hulls surrounding the genera. It looks like this reflects a latitudinal gradient in temperature! You can interact with the PCA plot by clicking on points to view associated metadata. You can isolate the genus you want to view by double clicking the genus in the legend! You can also remove a genus by clicking on it once. There's some other functionality you can explore in the toolbar at the top of the plot. The second plot is a PCA colored according to reproductive mode. It looks like asexual populations occupy slightly larger niche space, but both reproductive modes have a similar niche center.
```{r}

#add pca results to loc.clim data frame
loc.clim <- data.frame(loc.clim, clim.pca$x)

#use sourced plot_clim_pca function to plot the pca results. args are the data set with species names and PC axis values and the pca summary
all_pca <- plot_clim_pca(loc.clim, summary.pca, factor = "genus")
all_pca

#use sourced plot_clim_pca function to plot the pca results. args are the data set with species names and PC axis values and the pca summary
repro_pca <- plot_clim_pca(loc.clim, summary.pca, factor = "reproductive_mode")
repro_pca

#save the plot colored by genus
#htmlwidgets::saveWidget(all_pca, paste0(getwd(), "/plots/repro_mode_plots/all_species_pca_genus.html"), selfcontained = TRUE)

#save the plot colored by reproductive mode
#htmlwidgets::saveWidget(repro_pca, paste0(getwd(), "/plots/repro_mode_plots/all_species_pca_repro.html"), selfcontained = TRUE)



```







##PCA-Species {.tabset}
These are PCAs of environmental space for species within genera. Each climate PCA is of localities for a single genus, colored by species. I'm doing this even for genera with one species, so it's easy to see if certain localities group together. 

###Acanthoxyla
```{r}
#source function to conduct a PCA on individual species
summary.list.acan <- species_pca_fun(loc.clim, "acanthoxyla")
#plot
acan_plot <- plot_clim_pca(summary.list.acan$loc.clim, summary.list.acan$summary.pca, "reproductive_mode")

acan_plot

#save pca plot
#htmlwidgets::saveWidget(acan_plot, paste0(getwd(), "/plots/repro_mode_plots/acanthoxyla_pca.html"), selfcontained = TRUE)

#filter localities for the focal genus
acan_loc <- loc %>% 
  filter(genus == "acanthoxyla")
  
#use sourced plot_locs_leaflet script to plot localities
acan_map <- plot_locs_leaflet(acan_loc, "reproductive_mode")

acan_map

#in case I want to save the map somewhere
#mapview::mapshot(acan_map, url = paste0(getwd(), "/plots/repro_mode_plots/acan_map.html"), file = paste0(getwd(), "/plots/repro_mode_plots/acan_map.pdf"))
```


```{r}
summary.list.acan$summary.pca
loadings.acan <- summary.list.acan$summary.pca$rotation
knitr::kable(round(loadings.acan[,1:3],3)) #Table of loading scores for the first 3 PCs. 
```


###Argosarchus
```{r}
#conduct pca
summary.list.argo <- species_pca_fun(loc.clim, "argosarchus")
#plot
argo_plot <- plot_clim_pca(summary.list.argo$loc.clim, summary.list.argo$summary.pca, factor = "reproductive_mode")
argo_plot

#if selfcontained = TRUE, you can remove the folder that gets added alongside the plot. It's an annoying bug that hasn't been fixed yet.
#htmlwidgets::saveWidget(argo_plot, paste0(getwd(), "/plots/repro_mode_plots/argosarchus_pca.html"), selfcontained = TRUE)

#filter localities for the focal genus
argo_loc <- loc %>% 
  filter(genus == "argosarchus")
  
#use sourced plot_locs_leaflet script to plot localities
argo_map <- plot_locs_leaflet(argo_loc, "reproductive_mode")

argo_map

#in case I want to save the map somewhere
#mapview::mapshot(argo_map, url = paste0(getwd(), "/plots/repro_mode_plots/argo_map.html"), file = paste0(getwd(), "/plots/repro_mode_plots/argo_map.pdf"))


```

```{r}
summary.list.argo$summary.pca
loadings.argo <- summary.list.argo$summary.pca$rotation
knitr::kable(round(loadings.argo[,1:3],3)) #Table of loading scores for the first 3 PCs. 
```

Now I'm going to to environmental niche factor analysis between sexual and asexual populations within the species.
```{r}

#get background env't for the species
ahor_bg_env <- bg_env_crop(argo_loc, 
                           species = "horridus",
                           environment = w, 
                           buffer = 0.5)

#enfa for the sexual species
ahor_sexual_enfa <- enfa_calc_fun(locs = argo_loc, 
                                  species = "horridus", 
                                  reproductive_mode = "sexual", 
                                  mask_raster = ahor_bg_env)

#enfa for the asexual species
ahor_asexual_enfa <- enfa_calc_fun(locs = argo_loc, 
                                   species = "horridus", 
                                   reproductive_mode = "asexual", 
                                   mask_raster = ahor_bg_env)


#plot the marginality scores
marginality_lollipop(sex_marg = ahor_sexual_enfa$m, 
                    asex_marg = ahor_asexual_enfa$m,
                    full_species_name = "Argosarchus horridus")



```




###Asteliaphasma
```{r}
#pca
summary.list.aste <- species_pca_fun(loc.clim, "asteliaphasma")
#plot
aste_plot <- plot_clim_pca(summary.list.aste$loc.clim, summary.list.aste$summary.pca, factor = "reproductive_mode")
aste_plot

#if selfcontained = TRUE, you can remove the folder that gets added alongside the plot. It's an annoying bug that hasn't been fixed yet.
#htmlwidgets::saveWidget(aste_plot, paste0(getwd(), "/plots/repro_mode_plots/asteliaphasma_pca.html"), selfcontained = TRUE)

#filter localities for the focal genus
aste_loc <- loc %>% 
  filter(genus == "asteliaphasma")
  
#use sourced plot_locs_leaflet script to plot localities
aste_map <- plot_locs_leaflet(aste_loc, "reproductive_mode")

aste_map

#in case I want to save the map somewhere
#mapview::mapshot(aste_map, url = paste0(getwd(), "/plots/repro_mode_plots/aste_map.html"), file = paste0(getwd(), "/plots/repro_mode_plots/aste_map.pdf"))

```



```{r}
summary.list.aste$summary.pca
loadings.aste <- summary.list.aste$summary.pca$rotation
knitr::kable(round(loadings.aste[,1:3],3)) #Table of loading scores for the first 3 PCs. 
```



Now I'm going to to environmental niche factor analysis between sexual and asexual populations within the species.
```{r}
#get background env't for the species
ajuc_bg_env <- bg_env_crop(aste_loc, 
                           species = "jucundum",
                           environment = w, 
                           buffer = 0.5)

#enfa for the sexual species
ajuc_sexual_enfa <- enfa_calc_fun(locs = aste_loc, 
                                  species = "jucundum", 
                                  reproductive_mode = "sexual", 
                                  mask_raster = ajuc_bg_env)

#enfa for the asexual species
ajuc_asexual_enfa <- enfa_calc_fun(locs = aste_loc, 
                                   species = "jucundum", 
                                   reproductive_mode = "asexual", 
                                   mask_raster = ajuc_bg_env)


#plot the marginality scores
marginality_lollipop(sex_marg = ajuc_sexual_enfa$m, 
                    asex_marg = ajuc_asexual_enfa$m,
                    full_species_name = "Asteliaphasma jucundum")

```


###Clitarchus

```{r}
summary.list.clita <- species_pca_fun(loc.clim, "clitarchus")
clita_plot <- plot_clim_pca(summary.list.clita$loc.clim, summary.list.clita$summary.pca, factor = "reproductive_mode")
clita_plot

#if selfcontained = TRUE, you can remove the folder that gets added alongside the plot. It's an annoying bug that hasn't been fixed yet.
#htmlwidgets::saveWidget(clita_plot, paste0(getwd(), "/plots/repro_mode_plots/clitarchus_pca.html"), selfcontained = TRUE)

#filter localities for the focal genus
clita_loc <- loc %>% 
  filter(genus == "clitarchus")
  
#use sourced plot_locs_leaflet script to plot localities
clita_map <- plot_locs_leaflet(clita_loc, "reproductive_mode")

clita_map

#in case I want to save the map somewhere
#mapview::mapshot(clita_map, url = paste0(getwd(), "/plots/repro_mode_plots/clita_map.html"), file = paste0(getwd(), "/plots/repro_mode_plots/clita_map.pdf"))

```


```{r}
summary.list.clita$summary.pca
loadings.clita <- summary.list.clita$summary.pca$rotation
knitr::kable(round(loadings.clita[,1:3],3)) #Table of loading scores for the first 3 PCs. 
```


Now I'm going to to environmental niche factor analysis between sexual and asexual populations within the species.
```{r}
#get background env't for the species
choo_bg_env <- bg_env_crop(clita_loc, 
                           species = "hookeri",
                           environment = w, 
                           buffer = 0.5)

#enfa for the sexual species
choo_sexual_enfa <- enfa_calc_fun(locs = clita_loc, 
                                  species = "hookeri", 
                                  reproductive_mode = "sexual", 
                                  mask_raster = choo_bg_env)

#enfa for the asexual species
choo_asexual_enfa <- enfa_calc_fun(locs = clita_loc, 
                                   species = "hookeri", 
                                   reproductive_mode = "asexual", 
                                   mask_raster = choo_bg_env)


#plot the marginality scores
marginality_lollipop(sex_marg = choo_sexual_enfa$m, 
                    asex_marg = choo_asexual_enfa$m,
                    full_species_name = "Clitarchus hookeri")

```


###Micrarchus
```{r}
summary.list.micra <- species_pca_fun(loc.clim, "micrarchus")
micra_plot <- plot_clim_pca(summary.list.micra$loc.clim, summary.list.micra$summary.pca, factor = "reproductive_mode")
micra_plot

#if selfcontained = TRUE, you can remove the folder that gets added alongside the plot. It's an annoying bug that hasn't been fixed yet.
#htmlwidgets::saveWidget(micra_plot, paste0(getwd(), "/plots/repro_mode_plots/micrarchus_pca.html"), selfcontained = TRUE)

#filter localities for the focal genus
micra_loc <- loc %>% 
  filter(genus == "micrarchus")
  
#use sourced plot_locs_leaflet script to plot localities
micra_map <- plot_locs_leaflet(micra_loc, "reproductive_mode")

micra_map

#in case I want to save the map somewhere
mapview::mapshot(micra_map, url = paste0(getwd(), "/plots/repro_mode_plots/micra_map.html"), file = paste0(getwd(), "/plots/repro_mode_plots/micra_map.pdf"))
```


```{r}
summary.list.micra$summary.pca
loadings.micra <- summary.list.micra$summary.pca$rotation
knitr::kable(round(loadings.micra[,1:3],3)) #Table of loading scores for the first 3 PCs. 
```

###Niveaphasma

```{r}
summary.list.nive <- species_pca_fun(loc.clim, "niveaphasma")
nive_plot <- plot_clim_pca(summary.list.nive$loc.clim, summary.list.nive$summary.pca, factor = "reproductive_mode")

nive_plot

#if selfcontained = TRUE, you can remove the folder that gets added alongside the plot. It's an annoying bug that hasn't been fixed yet.
#htmlwidgets::saveWidget(nive_plot, paste0(getwd(), "/plots/repro_mode_plots/niveaphasma_pca.html"), selfcontained = TRUE)

#filter localities for the focal genus
nive_loc <- loc %>% 
  filter(genus == "niveaphasma")
  
#use sourced plot_locs_leaflet script to plot localities
nive_map <- plot_locs_leaflet(nive_loc, "reproductive_mode")

nive_map

#in case I want to save the map somewhere
#mapview::mapshot(nive_map, url = paste0(getwd(), "/plots/repro_mode_plots/nive_map.html"), file = paste0(getwd(), "/plots/repro_mode_plots/nive_map.pdf"))

```

```{r}
summary.list.nive$summary.pca
loadings.nive <- summary.list.nive$summary.pca$rotation
knitr::kable(round(loadings.nive[,1:3],3)) #Table of loading scores for the first 3 PCs. 
```


Now I'm going to to environmental niche factor analysis between sexual and asexual populations within the species.
```{r}
#get background env't for the species
nive_bg_env <- bg_env_crop(nive_loc, 
                           species = "annulata",
                           environment = w, 
                           buffer = 0.5)

#enfa for the sexual species
nive_sexual_enfa <- enfa_calc_fun(locs = nive_loc, 
                                  species = "annulata", 
                                  reproductive_mode = "sexual", 
                                  mask_raster = nive_bg_env)

#enfa for the asexual species
nive_asexual_enfa <- enfa_calc_fun(locs = nive_loc, 
                                   species = "annulata", 
                                   reproductive_mode = "asexual", 
                                   mask_raster = nive_bg_env)


#plot the marginality scores
marginality_lollipop(sex_marg = nive_sexual_enfa$m, 
                    asex_marg = nive_asexual_enfa$m,
                    full_species_name = "Niveaphasma annulata")

```


###Spinotectarchus

```{r}
summary.list.spin <- species_pca_fun(loc.clim, "spinotectarchus")
spin_plot <- plot_clim_pca(summary.list.spin$loc.clim, summary.list.spin$summary.pca, factor = "reproductive_mode")
spin_plot

#if selfcontained = TRUE, you can remove the folder that gets added alongside the plot. It's an annoying bug that hasn't been fixed yet.
#htmlwidgets::saveWidget(spin_plot, paste0(getwd(), "/plots/repro_mode_plots/spinotectarchus_pca.html"), selfcontained = TRUE)

#filter localities for the focal genus
spin_loc <- loc %>% 
  filter(genus == "spinotectarchus")
  
#use sourced plot_locs_leaflet script to plot localities
spin_map <- plot_locs_leaflet(spin_loc, "reproductive_mode")

spin_map

#in case I want to save the map somewhere
#mapview::mapshot(spin_map, url = paste0(getwd(), "/plots/repro_mode_plots/spin_map.html"), file = paste0(getwd(), "/plots/repro_mode_plots/spin_map.pdf"))
```


```{r}
summary.list.spin$summary.pca
loadings.spin <- summary.list.spin$summary.pca$rotation
knitr::kable(round(loadings.spin[,1:3],3)) #Table of loading scores for the first 3 PCs. 
```


###Tectarchus
```{r}
summary.list.tect <- species_pca_fun(loc.clim, "tectarchus")
tect_plot <- plot_clim_pca(summary.list.tect$loc.clim, summary.list.tect$summary.pca, factor = "reproductive_mode")
tect_plot

#if selfcontained = TRUE, you can remove the folder that gets added alongside the plot. It's an annoying bug that hasn't been fixed yet.
#htmlwidgets::saveWidget(tect_plot, paste0(getwd(), "/plots/repro_mode_plots/tectarchus_pca.html"), selfcontained = TRUE)

#filter localities for the focal genus
tect_loc <- loc %>% 
  filter(genus == "tectarchus")
  
#use sourced plot_locs_leaflet script to plot localities
tect_map <- plot_locs_leaflet(tect_loc, "reproductive_mode")

tect_map

#in case I want to save the map somewhere
#mapview::mapshot(tect_map, url = paste0(getwd(), "/plots/repro_mode_plots/tect_map.html"), file = paste0(getwd(), "/plots/repro_mode_plots/tect_map.pdf"))
```




```{r}
summary.list.tect$summary.pca
loadings.tect <- summary.list.tect$summary.pca$rotation
knitr::kable(round(loadings.tect[,1:3],3)) #Table of loading scores for the first 3 PCs. 
```



Now I'm going to to environmental niche factor analysis between sexual and asexual populations within the species.

This is for Tectarchus ovobessus.
```{r}
#get background env't for the species
tect_bg_env <- bg_env_crop(tect_loc, 
                           species = "ovobessus",
                           environment = w, 
                           buffer = 0.5)

#enfa for the sexual species
tect_ovo_sexual_enfa <- enfa_calc_fun(locs = tect_loc, 
                                  species = "ovobessus", 
                                  reproductive_mode = "sexual", 
                                  mask_raster = tect_bg_env)

#enfa for the asexual species
tect_ovo_asexual_enfa <- enfa_calc_fun(locs = tect_loc, 
                                   species = "ovobessus", 
                                   reproductive_mode = "asexual", 
                                   mask_raster = tect_bg_env)


#plot the marginality scores
marginality_lollipop(sex_marg = tect_ovo_sexual_enfa$m, 
                    asex_marg = tect_ovo_asexual_enfa$m,
                    full_species_name = "Tectarchus ovobessus")

```

This is an enfa for Tectarchus huttoni.
```{r}
###Only need to get bg env't if you're not running the previous chunk
#get background env't for the species
#tect_bg_env <- bg_env_crop(tect_loc, 
#                           species = "huttoni",
#                           environment = w, 
#                           buffer = 0.5)

#enfa for the sexual species
tect_hutt_sexual_enfa <- enfa_calc_fun(locs = tect_loc, 
                                  species = "huttoni", 
                                  reproductive_mode = "sexual", 
                                  mask_raster = tect_bg_env)

#enfa for the asexual species
tect_hutt_asexual_enfa <- enfa_calc_fun(locs = tect_loc, 
                                   species = "huttoni", 
                                   reproductive_mode = "asexual", 
                                   mask_raster = tect_bg_env)


#plot the marginality scores
marginality_lollipop(sex_marg = tect_hutt_sexual_enfa$m, 
                    asex_marg = tect_hutt_asexual_enfa$m,
                    full_species_name = "Tectarchus huttoni")

```


###Tepakiphasma
Nothing. Only one locality.

